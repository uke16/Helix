# HELIX v4 Test Infrastructure Stack
# Isolated test environment with different ports
# Used by the Self-Evolution System (Phase 14)

services:
  # ==========================================================================
  # DATABASES (Test Ports)
  # ==========================================================================

  postgres:
    image: postgres:16-alpine
    container_name: helix-test-postgres
    ports:
      - "127.0.0.1:5433:5432"
    volumes:
      - postgres-test-data:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-helix}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-helix_test_pass}
      - POSTGRES_DB=${POSTGRES_DB:-helix_test}
    networks:
      - helix-test-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-helix}"]
      interval: 10s
      timeout: 5s
      retries: 5

  neo4j:
    image: neo4j:5.15-community
    container_name: helix-test-neo4j
    ports:
      - "127.0.0.1:7475:7474"
      - "127.0.0.1:7688:7687"
    volumes:
      - neo4j-test-data:/data
      - neo4j-test-logs:/logs
    environment:
      - NEO4J_AUTH=${NEO4J_USER:-neo4j}/${NEO4J_PASSWORD:-helix_test_pass}
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*,gds.*
      - NEO4J_dbms_memory_heap_initial__size=256m
      - NEO4J_dbms_memory_heap_max__size=1G
    networks:
      - helix-test-network
    restart: unless-stopped

  qdrant:
    image: qdrant/qdrant:v1.7.4
    container_name: helix-test-qdrant
    ports:
      - "127.0.0.1:6335:6333"
      - "127.0.0.1:6336:6334"
    volumes:
      - qdrant-test-data:/qdrant/storage
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
    networks:
      - helix-test-network
    restart: unless-stopped

  redis:
    image: redis:7.2-alpine
    container_name: helix-test-redis
    ports:
      - "127.0.0.1:6380:6379"
    volumes:
      - redis-test-data:/data
    command: redis-server --appendonly yes
    networks:
      - helix-test-network
    restart: unless-stopped

networks:
  helix-test-network:
    driver: bridge
    name: helix-test-network

volumes:
  postgres-test-data:
    name: helix-test-postgres
  neo4j-test-data:
    name: helix-test-neo4j
  neo4j-test-logs:
    name: helix-test-neo4j-logs
  qdrant-test-data:
    name: helix-test-qdrant
  redis-test-data:
    name: helix-test-redis
