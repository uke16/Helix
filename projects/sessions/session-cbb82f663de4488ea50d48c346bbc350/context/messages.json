[
  {
    "role": "user",
    "content": "# Consultant Request: Streaming Completion Signal - Aufr\u00e4umen & ADR\n\n## Kontext\n\nWir haben ein Problem mit dem Streaming-System entdeckt und analysiert:\n\n### Das Problem\n1. stdout vom Claude CLI Prozess kann vorzeitig schlie\u00dfen (Bug)\n2. Die API nutzte stdout-Ende als \"fertig\"-Signal\n3. Das f\u00fchrte zu unvollst\u00e4ndigen Responses\n\n### Was wir rausgefunden haben\n1. Die API schreibt status.json, NICHT Claude\n2. Der `step` Wert (what/why/constraints/generate/done) wird von einem FALLBACK auf \"done\" gesetzt wenn kein Step-Marker gefunden wird\n3. Das ist SUGAR COATING - es versteckt das Problem statt es zu l\u00f6sen\n\n### Die L\u00f6sung\nClaude CLI hat einen `SessionEnd` Hook. Wir haben einen Hook erstellt:\n```bash\n~/.claude/hooks/session-end.sh\n# Schreibt output/.done wenn Claude WIRKLICH fertig ist\n```\n\nDie API sollte auf diese Datei warten, nicht auf stdout-Ende.\n\n## Aufgaben\n\n### 1. ADR erstellen\nErstelle ein ADR das beschreibt:\n- Das Problem (stdout disconnect, step=\"done\" Fallback als Sugar Coating)\n- Die L\u00f6sung (SessionEnd Hook + .done Datei als Completion-Signal)\n- Was entfernt werden soll\n\n### 2. Identifiziere zu l\u00f6schenden Code\n\nFinde alles was Sugar Coating ist:\n- StepMarkerValidator Fallback (default \"done\")\n- _infer_step() Funktion\n- Eventuell das ganze STEP-System wenn nicht anderweitig gebraucht\n\nFragen:\n- Wird `step` in status.json f\u00fcr irgendwas wichtiges gebraucht?\n- Welche ADRs haben den Sugar Coating Code eingef\u00fchrt?\n- K\u00f6nnen wir selektiv git revert machen?\n\n### 3. Git History analysieren\n\nWelche Commits haben den Fallback-Code eingef\u00fchrt?\n- ADR-038: Deterministic LLM Response Enforcement\n- ADR-034: Consultant Flow Refactoring\n\nK\u00f6nnen wir diese teilweise reverten?\n\n## Dateien zum Anschauen\n\n- `/home/aiuser01/helix-v4/src/helix/enforcement/validators/step_marker.py` - StepMarkerValidator mit Fallback\n- `/home/aiuser01/helix-v4/src/helix/enforcement/response_enforcer.py` - Response Enforcer\n- `/home/aiuser01/helix-v4/src/helix/api/routes/openai.py` - API Routes\n- `/home/aiuser01/helix-v4/adr/034-consultant-flow-refactoring-llm-native.md`\n- `/home/aiuser01/helix-v4/adr/038-*.md`\n\n## Erwartetes Ergebnis\n\n1. Ein ADR das die Architektur\u00e4nderung beschreibt\n2. Liste der zu l\u00f6schenden/vereinfachenden Code-Teile\n3. Empfehlung ob git revert oder manuelles Aufr\u00e4umen"
  }
]