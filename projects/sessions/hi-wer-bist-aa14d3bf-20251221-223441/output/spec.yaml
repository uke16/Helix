# HELIX Self-Evolution System
# Cross-Instance Development & Integration Framework

name: HELIX Self-Evolution System
type: feature
description: |
  Ermöglicht HELIX, sich selbst sicher weiterzuentwickeln durch
  isolierte Entwicklung im Test-System und kontrollierte Integration.

goals:
  - HELIX kann eigene Features entwickeln ohne sich selbst zu zerstören
  - Isoliertes Test-System (helix-v4-test) für sichere Entwicklung
  - Automatische Integration mit Validierung und Rollback-Möglichkeit
  - Vergleichstests zwischen Main und Test-System möglich
  - Direkte Kommunikation mit Consultant ohne Umwege über Claude Desktop

requirements:
  # Architektur
  - Git-basierte Trennung: trunk (helix-v4) und dev (helix-v4-test)
  - Gespiegelte Verzeichnisstruktur zwischen Main und Test
  - Isolierte Docker-Container für Test-System (Datenbanken, Cache)
  - Cross-Instance Kommunikation zwischen Consultant und Developer

  # Entwicklungs-Workflow
  - Consultant erarbeitet Feature-Spec mit User
  - Developer-Instanz arbeitet im Test-System (nicht im Main)
  - Code wird in helix-v4-test implementiert
  - Dokumentation wird parallel erstellt

  # Integration
  - Chat-basierter Integration-Trigger ("Integriere jetzt")
  - Automatische Frage vor Integration ("Fertig. Soll ich integrieren?")
  - Vollständige Validierung nach Integration
  - E2E-Tests über API zur Funktionsprüfung
  - Logs und Metriken zur Erfolgsmessung

  # Qualitätssicherung
  - Syntax-Validierung aller geänderten Dateien
  - Unit-Tests müssen bestehen
  - E2E-Tests gegen das Test-System
  - Optional: Benchmark-Vergleich Main vs Test

constraints:
  - Consultant darf NIE helix-v4 Dateien direkt modifizieren
  - Integration nur über definierten Mechanismus
  - Rollback muss bei Fehlern möglich sein
  - Test-System muss unabhängig startbar sein
  - Keine Breaking Changes an der API während Evolution

context:
  what: |
    Ein System das HELIX ermöglicht, sich selbst weiterzuentwickeln.

    Der User diskutiert mit dem Consultant ein neues Feature
    (z.B. "neues Quality Gate" oder "Spec Verifier"). Der Consultant
    generiert die Spezifikation. Eine Developer-Instanz implementiert
    das Feature im helix-v4-test Verzeichnis. Nach Fertigstellung
    wird das Feature validiert und in helix-v4 (Main) integriert.

    Kernkomponenten:
    1. TestEnvironmentManager - Verwaltet helix-v4-test
    2. CrossInstanceBridge - Kommunikation Consultant <-> Developer
    3. IntegrationManager - Sichere Code-Integration
    4. ValidationSuite - E2E-Tests und Vergleiche

  why: |
    Aktuell ist die HELIX-Entwicklung problematisch:
    - Claude Code könnte eigene Dateien überschreiben
    - Syntax-Fehler könnten das System unbrauchbar machen
    - Keine Isolation zwischen Entwicklung und Produktion
    - User muss Umwege über Claude Desktop gehen

    Das Self-Evolution System löst diese Probleme durch:
    - Strikte Trennung von Main und Test-System
    - Kontrollierte, validierte Integration
    - Direkte Kommunikation ohne externe Tools

  stakeholders:
    - HELIX-Entwickler (User die HELIX erweitern wollen)
    - HELIX selbst (als sich entwickelndes System)

technical:
  language: python
  frameworks:
    - FastAPI (API-Erweiterungen)
    - asyncio (Cross-Instance Kommunikation)
    - GitPython (Branch/Sync Management)
    - pytest (E2E-Tests)
  integrations:
    - helix-v4 (Main System)
    - helix-v4-test (Test System)
    - Docker (Container-Isolation)
    - GitLab/Git (Versionierung)

# Architektur-Skizze
architecture: |
  ┌─────────────────────────────────────────────────────────────────────┐
  │                        HELIX Self-Evolution                          │
  ├─────────────────────────────────────────────────────────────────────┤
  │                                                                      │
  │  ┌──────────────────────────────────────────────────────────────┐   │
  │  │  helix-v4 (TRUNK/MAIN)                                       │   │
  │  │  ────────────────────────────────────────────────────────────│   │
  │  │  • Produktives System                                        │   │
  │  │  • Consultant läuft hier                                     │   │
  │  │  • Wird NIE direkt modifiziert bei Evolution                 │   │
  │  │  • Docker: helix-api, helix-db (produktiv)                   │   │
  │  └──────────────────────────────────────────────────────────────┘   │
  │                              │                                       │
  │                              │ Integration                           │
  │                              │ (validiert)                           │
  │                              ▼                                       │
  │  ┌──────────────────────────────────────────────────────────────┐   │
  │  │  helix-v4-test (DEV/BRANCH)                                  │   │
  │  │  ────────────────────────────────────────────────────────────│   │
  │  │  • Gespiegelte Struktur                                      │   │
  │  │  • Developer-Instanzen arbeiten hier                         │   │
  │  │  • Kann "kaputt gehen" ohne Main zu beeinflussen             │   │
  │  │  • Docker: helix-api-test, helix-db-test (isoliert)          │   │
  │  └──────────────────────────────────────────────────────────────┘   │
  │                                                                      │
  │  Workflow:                                                           │
  │  ┌─────────────────────────────────────────────────────────────────┐│
  │  │ 1. User ←→ Consultant: Feature besprechen                      ││
  │  │ 2. Consultant: spec.yaml + phases.yaml generieren              ││
  │  │ 3. Consultant → Developer: "Implementiere in helix-v4-test"    ││
  │  │ 4. Developer: Code schreiben, Tests, Doku                      ││
  │  │ 5. Developer → Consultant: "Fertig. Soll ich integrieren?"     ││
  │  │ 6. User: "Ja, integriere!"                                     ││
  │  │ 7. IntegrationManager: Validieren → Kopieren → E2E-Tests       ││
  │  │ 8. Bei Erfolg: Main ist aktualisiert                           ││
  │  │ 9. Bei Fehler: Rollback, User informieren                      ││
  │  └─────────────────────────────────────────────────────────────────┘│
  │                                                                      │
  └─────────────────────────────────────────────────────────────────────┘

# Neue Module die erstellt werden
new_modules:
  - name: evolution/test_environment.py
    purpose: Verwaltet helix-v4-test (Setup, Sync, Cleanup)

  - name: evolution/cross_instance.py
    purpose: Kommunikation zwischen Consultant und Developer-Instanzen

  - name: evolution/integration_manager.py
    purpose: Sichere Integration von Test nach Main

  - name: evolution/validation_suite.py
    purpose: E2E-Tests und Vergleichstests

# Erweiterungen bestehender Module
modifications:
  - file: src/helix/orchestrator.py
    change: Cross-Instance Workflow Support

  - file: src/helix/consultant/meeting.py
    change: Evolution-Mode für HELIX-interne Projekte

  - file: src/helix/api/routes/helix.py
    change: Integration-Trigger Endpoint
