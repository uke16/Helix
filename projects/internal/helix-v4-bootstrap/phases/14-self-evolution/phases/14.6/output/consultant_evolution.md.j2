{#
  Evolution Project Template Extension for Consultant Sessions

  This template extends the base session.md.j2 to add evolution-specific
  information when the consultant is creating a `type: evolution` project.

  Usage: Include this section in session.md.j2 after the generate phase
  instructions when the project type is 'evolution'.
#}

{% if project_type == "evolution" %}
---

## Evolution-Projekt Spezifikation

> **WICHTIG**: Du erstellst ein **Evolution-Projekt** - ein Projekt das HELIX selbst weiterentwickelt.

### Was ist ein Evolution-Projekt?

Evolution-Projekte sind spezielle Projekte die neue Features oder Änderungen an HELIX v4 selbst implementieren. Sie durchlaufen einen kontrollierten Workflow:

```
┌──────────────────────────────────────────────────────────────────────────┐
│                    HELIX Self-Evolution Workflow                          │
│                                                                           │
│   ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────────┐       │
│   │ pending  │───►│developing│───►│  ready   │───►│   deployed   │       │
│   └──────────┘    └──────────┘    └──────────┘    └──────────────┘       │
│        │                                                   │              │
│        │          Consultant           Developer         Test             │
│        │          erstellt             Phasen           System            │
│        │          Projekt              laufen                             │
│        │                                                   │              │
│        │                                                   ▼              │
│        │                          ┌──────────────┐    ┌──────────┐       │
│        └─────────────────────────►│   failed     │◄───│validated │       │
│                                   └──────────────┘    └──────────┘       │
│                                         │                   │             │
│                                         │                   ▼             │
│                                         │             ┌──────────┐       │
│                                         └────────────►│integrated│       │
│                                                       └──────────┘       │
│                                                             │             │
│                                                             ▼             │
│                                                        Production         │
└──────────────────────────────────────────────────────────────────────────┘
```

### Unterschiede zu normalen Projekten

| Aspekt | Normales Projekt | Evolution-Projekt |
|--------|------------------|-------------------|
| Ziel | Externes Feature | HELIX Weiterentwicklung |
| Output | Beliebig | `new/` und `modified/` Verzeichnisse |
| Deployment | Manuell | Via Evolution-API |
| Validation | Manuell | Automatisiert (Syntax + Tests) |
| Integration | Manuell | Kontrolliert mit Backup |

### Projekt-Struktur für Evolution

Evolution-Projekte haben eine spezielle Struktur:

```
projects/evolution/{projekt-name}/
├── spec.yaml           # Projekt-Spezifikation
├── phases.yaml         # Phasen-Definition
├── status.json         # Status-Tracking (automatisch)
├── new/                # NEUE Dateien (gespiegelte Struktur)
│   └── src/helix/
│       └── neue_datei.py
├── modified/           # MODIFIZIERTE Dateien (Kopien)
│   └── src/helix/
│       └── existierende_datei.py
└── phases/             # Phasen-Arbeitsverzeichnisse
    ├── 01-analysis/
    │   └── output/
    └── 02-implementation/
        └── output/
```

### spec.yaml für Evolution-Projekte

Verwende `type: evolution` in der spec.yaml:

```yaml
name: {{ "{{ name }}" }}
type: evolution                    # <-- WICHTIG: evolution statt feature
description: {{ "{{ beschreibung }}" }}

goals:
  - {{ "{{ ziel_1 }}" }}
  - {{ "{{ ziel_2 }}" }}

requirements:
  - {{ "{{ anforderung_1 }}" }}

constraints:
  - Muss kompatibel mit bestehender HELIX-Architektur sein
  - Darf keine Breaking Changes an der API einführen
  - Tests müssen bestehen

context:
  what: |
    {{ "{{ was_wird_gebaut }}" }}
  why: |
    {{ "{{ warum_wird_es_gebraucht }}" }}

evolution:                         # <-- Evolution-spezifischer Block
  affects:
    - src/helix/...               # Welche Bereiche betroffen
  new_files:
    - src/helix/new_module.py     # Geplante neue Dateien
  modified_files:
    - src/helix/existing.py       # Geplante Änderungen
```

### phases.yaml für Evolution-Projekte

Developer-Phasen müssen Output in `new/` und `modified/` schreiben:

```yaml
phases:
  - id: 01-analysis
    name: Code-Analyse
    type: development
    description: |
      Analysiere bestehenden Code und plane die Änderungen.
    config:
      skills: [helix]
    output:
      files:
        - phases/01-analysis/output/analysis.md
        - phases/01-analysis/output/change-plan.md
    quality_gate:
      type: files_exist

  - id: 02-implementation
    name: Implementation
    type: development
    description: |
      Implementiere die geplanten Änderungen.

      WICHTIG:
      - Neue Dateien nach `new/` schreiben (gespiegelte Struktur)
      - Modifizierte Dateien nach `modified/` kopieren
    config:
      skills: [helix, infrastructure]
    input:
      files:
        - phases/01-analysis/output/change-plan.md
    output:
      files:
        - new/src/helix/...       # Neue Dateien
        - modified/src/helix/...  # Modifizierte Dateien
    quality_gate:
      type: python_syntax

  - id: 03-testing
    name: Unit Tests
    type: development
    description: |
      Schreibe Tests für die neuen/geänderten Module.
    input:
      files:
        - new/**/*.py
        - modified/**/*.py
    output:
      files:
        - new/tests/...           # Neue Test-Dateien
    quality_gate:
      type: tests_pass
```

### Nach der Spezifikation

Nachdem du spec.yaml und phases.yaml erstellt hast:

1. **Projekt wird erstellt** - HELIX erstellt das Evolution-Projekt
2. **Developer-Phasen laufen** - Claude Code Instanzen implementieren
3. **Status: READY** - Wenn alle Phasen fertig sind

### Evolution-Workflow nach Entwicklung

Der User kann dann via API den Workflow fortsetzen:

```bash
# Deploy to Test System
POST /helix/evolution/projects/{name}/deploy

# Run Validation (Syntax + Unit Tests + E2E)
POST /helix/evolution/projects/{name}/validate

# Integrate to Production (with git backup)
POST /helix/evolution/projects/{name}/integrate

# Rollback if needed
POST /helix/evolution/projects/{name}/rollback
```

### Wichtige Hinweise

1. **Backup-Sicherheit**: Vor jeder Integration wird ein Git-Tag erstellt
2. **Test-System**: Änderungen werden zuerst auf helix-v4-test getestet
3. **RAG-Sync**: Qdrant-Daten können zum Test-System synchronisiert werden
4. **Rollback**: Jederzeit möglich via API

### Beispiel: Neues HELIX-Modul

Wenn der User z.B. "Ein neues Logging-Modul für HELIX" anfragt:

**spec.yaml:**
```yaml
name: enhanced-logging
type: evolution
description: Erweitertes Logging-System für HELIX mit strukturierten Logs

goals:
  - Strukturierte JSON-Logs
  - Log-Level Konfiguration
  - Request-Tracing

evolution:
  affects:
    - src/helix/core/
    - src/helix/api/
  new_files:
    - src/helix/core/logging.py
    - src/helix/core/tracing.py
  modified_files:
    - src/helix/api/main.py
```

---

{% endif %}

{#
  INTEGRATION INSTRUCTIONS:

  To integrate this into the main session.md.j2 template:

  1. Add a new template variable: project_type (default: "feature")

  2. In the "generate" step section, add this include after the existing
     phases.yaml example:

     {% include 'consultant_evolution.md.j2' %}

  3. Or copy the content above into session.md.j2 directly.

  4. Update the ConsultantMeeting class to set project_type based on
     user intent or explicit request.
#}
