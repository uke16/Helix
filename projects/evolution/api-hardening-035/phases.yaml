# ADR-035: Consultant API Hardening - Security & Reliability Fixes
# FIX-ADR: 19 Bugs konsolidiert, 8 Fixes in 3 Phasen

project:
  name: "api-hardening-035"
  description: "ADR-035: Consultant API Hardening - Security & Reliability Fixes"
  adr: "ADR-035.md"

phases:
  # ============================================================
  # PHASE 1: Security Fixes (KRITISCH)
  # ============================================================

  - id: "01"
    name: "Security: Session IDs"
    type: development
    description: |
      Kryptografisch sichere Session-IDs mit uuid4 statt Hash.

      PROBLEM: Session-IDs sind vorhersagbar (Hash der ersten Nachricht).

      LÖSUNG in session_manager.py:
      - Neue Methode _generate_session_id() mit uuid4
      - get_or_create_session() nutzt Random ID statt deterministisch
      - Conversation-ID Support (ADR-029) bleibt erhalten

      Siehe ADR-035.md Fix 1 für Code-Beispiel.
    output:
      - phases/01/output/modified/src/helix/api/session_manager.py
    quality_gate:
      type: syntax_check
      file_patterns:
        - "output/**/*.py"

  - id: "02"
    name: "Security: Input Validation"
    type: development
    description: |
      Input Validation Middleware für Role und Message-Size.

      PROBLEM: Keine Limits für Message-Größe, keine Role-Validation.

      LÖSUNG:
      - Neue Datei middleware/input_validator.py
      - MAX_MESSAGE_LENGTH = 100_000 (100KB)
      - MAX_MESSAGES_PER_REQUEST = 100
      - VALID_ROLES = {"user", "assistant", "system"}
      - Integration in openai.py

      Erstelle auch Unit Tests.

      Siehe ADR-035.md Fix 2 für Code-Beispiel.
    input:
      - phases/01/output/modified/src/helix/api/session_manager.py
    output:
      - phases/02/output/new/src/helix/api/middleware/__init__.py
      - phases/02/output/new/src/helix/api/middleware/input_validator.py
      - phases/02/output/new/tests/api/test_input_validator.py
      - phases/02/output/modified/src/helix/api/routes/openai.py
    quality_gate:
      type: syntax_check
      file_patterns:
        - "output/**/*.py"

  - id: "03"
    name: "Security: Rate Limiting"
    type: development
    description: |
      Rate Limiting mit slowapi (10 req/min pro IP).

      PROBLEM: Unbegrenzte parallele Claude-Prozesse möglich.

      LÖSUNG:
      - Neue Datei middleware/rate_limiter.py mit slowapi
      - @limiter.limit("10/minute") Decorator
      - Integration in openai.py und main.py

      Erstelle auch Unit Tests.

      Siehe ADR-035.md Fix 3 für Code-Beispiel.
    input:
      - phases/02/output/modified/src/helix/api/routes/openai.py
    output:
      - phases/03/output/new/src/helix/api/middleware/rate_limiter.py
      - phases/03/output/new/tests/api/test_rate_limiter.py
      - phases/03/output/modified/src/helix/api/routes/openai.py
      - phases/03/output/modified/src/helix/api/main.py
    quality_gate:
      type: syntax_check
      file_patterns:
        - "output/**/*.py"

  # ============================================================
  # PHASE 2: Reliability Fixes (HOCH)
  # ============================================================

  - id: "04"
    name: "Reliability: File Locking"
    type: development
    description: |
      Race Condition Prevention mit filelock.

      PROBLEM: TOCTOU bei Session-Erstellung.

      LÖSUNG in session_manager.py:
      - import filelock
      - FileLock bei get_or_create_session()
      - Atomic creation mit Lock

      Siehe ADR-035.md Fix 4 für Code-Beispiel.
    input:
      - phases/01/output/modified/src/helix/api/session_manager.py
    output:
      - phases/04/output/modified/src/helix/api/session_manager.py
    quality_gate:
      type: syntax_check
      file_patterns:
        - "output/**/*.py"

  - id: "05"
    name: "Reliability: Path Sanitization"
    type: development
    description: |
      Path Traversal Prevention mit Sanitization.

      PROBLEM: User-Content in Pfadnamen ohne Sanitization.

      LÖSUNG in session_manager.py:
      - _normalize_conversation_id() verbessern
      - Path traversal entfernen (.., /, \)
      - Nur alphanumerisch + Bindestrich erlauben
      - Länge auf 64 Zeichen begrenzen

      Erstelle auch Unit Tests für Path Sanitization.

      Siehe ADR-035.md Fix 5 für Code-Beispiel.
    input:
      - phases/04/output/modified/src/helix/api/session_manager.py
    output:
      - phases/05/output/new/tests/api/test_session_security.py
      - phases/05/output/modified/src/helix/api/session_manager.py
    quality_gate:
      type: syntax_check
      file_patterns:
        - "output/**/*.py"

  - id: "06"
    name: "Reliability: Session Archivierung"
    type: development
    description: |
      Session Archivierung (Zip, nichts löschen!).

      PROBLEM: Sessions wachsen unbegrenzt.

      ANFORDERUNG: Alle Daten sollen erhalten bleiben!

      LÖSUNG in session_manager.py:
      - archive_old_sessions() - Sessions > 30 Tage zippen
      - _archive_session() - Einzelne Session archivieren
      - create_yearly_backup() - Jahres-Backup
      - Verzeichnisstruktur: _archive/, _backups/

      Siehe ADR-035.md Fix 6 für vollständigen Code.
    input:
      - phases/05/output/modified/src/helix/api/session_manager.py
    output:
      - phases/06/output/modified/src/helix/api/session_manager.py
    quality_gate:
      type: syntax_check
      file_patterns:
        - "output/**/*.py"

  # ============================================================
  # PHASE 3: Code Quality (MITTEL)
  # ============================================================

  - id: "07"
    name: "Code Quality: Zentrale Paths"
    type: development
    description: |
      Zentrale PathConfig mit Environment Variable Support.

      PROBLEM: Hardcoded Paths an 5+ Stellen.

      LÖSUNG:
      - Neue Datei config/paths.py mit PathConfig Klasse
      - HELIX_ROOT, VENV_PATH, CLAUDE_CMD, NVM_PATH
      - ensure_claude_path() Methode
      - Integration in claude_runner.py und openai.py

      Siehe ADR-035.md Fix 7 und 8 für Code-Beispiele.
    input:
      - phases/06/output/modified/src/helix/api/session_manager.py
      - phases/03/output/modified/src/helix/api/routes/openai.py
    output:
      - phases/07/output/new/src/helix/config/paths.py
      - phases/07/output/modified/src/helix/claude_runner.py
      - phases/07/output/modified/src/helix/api/routes/openai.py
    quality_gate:
      type: syntax_check
      file_patterns:
        - "output/**/*.py"

  # ============================================================
  # PHASE 4: Testing & Documentation
  # ============================================================

  - id: "08"
    name: "Testing"
    type: test
    description: |
      Alle Tests ausführen und verifizieren.

      Tests:
      - tests/api/test_input_validator.py
      - tests/api/test_rate_limiter.py
      - tests/api/test_session_security.py

      Alle müssen bestehen.
    input:
      - phases/02/output/new/tests/api/test_input_validator.py
      - phases/03/output/new/tests/api/test_rate_limiter.py
      - phases/05/output/new/tests/api/test_session_security.py
    output:
      - phases/08/output/TEST_RESULTS.md
    quality_gate:
      type: files_exist
      required_files:
        - output/TEST_RESULTS.md

  - id: "09"
    name: "Documentation"
    type: documentation
    description: |
      ARCHITECTURE-MODULES.md mit Security-Sektion aktualisieren.

      Dokumentiere:
      - Input Validation Middleware
      - Rate Limiting
      - Session Security (IDs, Path Sanitization)
      - Archivierung
      - Zentrale PathConfig
    output:
      - phases/09/output/modified/docs/ARCHITECTURE-MODULES.md
    quality_gate:
      type: files_exist
      required_files:
        - output/modified/docs/ARCHITECTURE-MODULES.md
