{# CLAUDE.md.j2 - Main template for root CLAUDE.md #}
{# Target: ~300 lines, compact overview with references to Skills #}

# HELIX v4 - Instructions for Claude Code

> **Du arbeitest im HELIX v4 Projekt** - einem AI Development Orchestration System.
>
> Lies diese Datei um zu verstehen wie du hier arbeiten sollst.

---

## Projekt verstehen

HELIX orchestriert Claude Code Instanzen um Software zu entwickeln. Du bist möglicherweise:

1. **Consultant** - Führst ein Meeting mit dem User, generierst spec.yaml
2. **Developer** - Implementierst Code basierend auf Spezifikation
3. **Reviewer** - Überprüfst Code auf Qualität
4. **Dokumentation** - Schreibst technische Dokumentation

### Deine Rolle erkennen

Schau in deinem Arbeitsverzeichnis nach:
- `CLAUDE.md` - Enthält spezifische Anweisungen für deine Phase
- `input/` - Dateien die du als Input lesen sollst
- `output/` - Hier schreibst du deine Ergebnisse

---

## Wichtige Dateien zuerst lesen

### Immer lesen:
1. Diese Datei (CLAUDE.md im Root)
2. CLAUDE.md in deinem Phase-Verzeichnis
3. Relevante Skills in `skills/`

### Skills nach Bedarf:
{% if domains is defined and domains.domains is defined %}
{% for domain in domains.domains %}
- `{{ domain.skills[0].path }}` - {{ domain.description_short }}
{% endfor %}
{% else %}
- `skills/helix/SKILL.md` - Wie HELIX funktioniert
- `skills/helix/adr/SKILL.md` - Wie man ADRs schreibt
- `skills/pdm/SKILL.md` - PDM System (Stücklisten, Artikel)
- `skills/encoder/SKILL.md` - POSITAL Encoder Produkte
- `skills/infrastructure/SKILL.md` - Docker, PostgreSQL, etc.
{% endif %}

---

## Output-Regeln

### Dateien erstellen
- Schreibe Ergebnisse nach `output/` in deinem Phase-Verzeichnis
- Nutze sprechende Dateinamen: `schema-analysis.md`, `config_validator.py`
- Erstelle keine Dateien außerhalb deines Arbeitsverzeichnisses

### Formate
- `.yaml` für Konfiguration und Specs
- `.py` für Python Code
- `.md` für Dokumentation und Analysen

### Quality Gates
Dein Output wird automatisch validiert:
- Existieren alle erwarteten Dateien?
- Ist der Code syntaktisch korrekt?
- Laufen die Tests?

-> Schau in `phases.yaml` welche Output-Dateien erwartet werden.

---

## Quality Gates Reference

HELIX verwendet Quality Gates um die Qualität deiner Arbeit zu validieren.

### Verfügbare Gate-Typen

| Gate Type | Beschreibung | Verwendung |
|-----------|--------------|------------|
{% if quality_gates is defined and quality_gates.gates is defined %}
{% for gate in quality_gates.gates %}
| `{{ gate.id }}` | {{ gate.description_short }} | {{ gate.phase_usage | join(', ') }} |
{% endfor %}
{% else %}
| `files_exist` | Prüft ob Dateien existieren | development, documentation |
| `syntax_check` | Prüft Python/TS/Go Syntax | development |
| `tests_pass` | Führt pytest/jest aus | testing |
| `review_approved` | LLM-Review des Outputs | review |
| `adr_valid` | Validiert ADR-Dokumente | consultant, review |
{% endif %}

{% if quality_gates is defined and quality_gates.gates is defined %}
{% for gate in quality_gates.gates %}
{% if gate.id == 'adr_valid' %}
### Gate: `adr_valid`

Validiert Architecture Decision Records gegen das ADR-086 Template:

```yaml
# phases.yaml
quality_gate:
  type: adr_valid
  file: output/feature-adr.md
```

**Was wird geprüft:**

1. **YAML Header** (Pflichtfelder)
{% for field in gate.required_yaml_fields %}
   - `{{ field }}`
{% endfor %}

2. **Markdown Sections** (alle müssen vorhanden sein)
{% for section in gate.required_sections %}
   - `{{ section }}`
{% endfor %}

3. **Akzeptanzkriterien**
   - Mindestens ein `- [ ]` oder `- [x]` Checkbox vorhanden

-> Siehe: [docs/ADR-TEMPLATE.md](docs/ADR-TEMPLATE.md) für das vollständige Template.
{% endif %}
{% endfor %}
{% endif %}

---

## Phase Types

HELIX unterstützt verschiedene Phase-Typen:

| Type | Rolle | Outputs |
|------|-------|---------|
{% if phase_types is defined and phase_types.phase_types is defined %}
{% for phase in phase_types.phase_types %}
| `{{ phase.id }}` | {{ phase.role }} | {{ phase.outputs | map(attribute='type') | join(', ') }} |
{% endfor %}
{% else %}
| `consultant` | Consultant | adr, spec, phases |
| `development` | Developer | code, tests |
| `testing` | Developer | test_results |
| `review` | Reviewer | review_report |
| `documentation` | Documentation | docs |
{% endif %}

-> Details: [skills/helix/SKILL.md](skills/helix/SKILL.md)

---

## Projekt-Struktur

```
helix-v4/
├── CLAUDE.md              <- Diese Datei
├── ONBOARDING.md          <- Konzept-Erklärung
│
├── src/helix/             # Python Orchestrator
├── config/                # Konfiguration
├── templates/             # CLAUDE.md Templates
├── skills/                # Domain-Wissen
│
├── projects/
│   ├── sessions/          # Consultant Sessions
│   │   └── {session-id}/
│   │       ├── CLAUDE.md
│   │       ├── input/
│   │       └── output/
│   │
│   └── external/          # Ausführbare Projekte
│       └── {projekt-name}/
│           ├── spec.yaml
│           ├── phases.yaml
│           └── phases/
```

---

## Consultant-Rolle

Wenn du als **Consultant** arbeitest:

### Deine Aufgabe
1. Lies den User-Request in `input/request.md`
2. Lies relevante Skills (`skills/pdm/`, etc.)
3. Stelle klärende Fragen (Was? Warum? Constraints?)
4. Generiere `output/spec.yaml` und `output/phases.yaml`

-> Details: [skills/helix/SKILL.md](skills/helix/SKILL.md)

---

## Developer-Rolle

Wenn du als **Developer** arbeitest:

### Deine Aufgabe
1. Lies `spec.yaml` im Projekt-Root
2. Lies deine Phase-CLAUDE.md für spezifische Anweisungen
3. Lies Input-Dateien aus vorherigen Phasen
4. Implementiere und schreibe nach `output/`

### Code-Standards
- Python: PEP 8, Type Hints, Docstrings
- Dateien: UTF-8, Unix Line Endings
- Tests: pytest Format

---

## Wichtige Hinweise

### DO:
- Lies CLAUDE.md in deinem Verzeichnis
- Lies relevante Skills
- Schreibe nach output/
- Erstelle vollständige, lauffähige Dateien
- Dokumentiere was du getan hast

### DON'T:
- Ändere keine Dateien außerhalb deines Verzeichnisses
- Lösche keine existierenden Dateien
- Installiere keine System-Pakete
- Mache keine Netzwerk-Requests ohne Grund

---

## Escalation

{% if escalation is defined and escalation.escalation is defined %}
Bei Fehlern eskaliert HELIX automatisch:

| Level | Name | Aktion |
|-------|------|--------|
{% for level in escalation.escalation.levels %}
| {{ level.level }} | {{ level.name }} | {{ level.action }} |
{% endfor %}
{% else %}
Bei Fehlern eskaliert HELIX automatisch:

| Level | Name | Aktion |
|-------|------|--------|
| 1 | Phase Retry | retry_phase |
| 2 | Domain Expert | escalate_to_domain |
| 3 | Architecture Review | architecture_review |
| 4 | Human Intervention | pause_for_human |
{% endif %}

-> Details: [skills/helix/SKILL.md](skills/helix/SKILL.md)

---

## Evolution Projects

HELIX supports self-evolution through isolated test system validation.

### Project Type: evolution

Evolution projects live in `projects/evolution/{name}/`:

```
projects/evolution/new-feature/
├── spec.yaml        # Project specification
├── phases.yaml      # Development phases
├── status.json      # Current status
├── new/             # New files to create
└── modified/        # Modified files
```

### Status Flow

```
PENDING -> DEVELOPING -> READY -> DEPLOYED -> VALIDATED -> INTEGRATED
                               |           |
                            FAILED <- <- ROLLBACK
```

---

## Self-Documentation Prinzip

> **Jede Änderung dokumentiert sich selbst.**

Wenn du ein neues Feature implementierst, müssen aktualisiert werden:
- Top-Level (README, ONBOARDING, CLAUDE.md)
- Architecture Docs (docs/*.md)
- Skills (skills/*/SKILL.md)
- Docstrings (im Code)

-> Lies: [docs/SELF-DOCUMENTATION.md](docs/SELF-DOCUMENTATION.md)

---

## Available Tools

### ADR Tool (`helix.tools.adr_tool`)

```bash
python -m helix.tools.adr_tool validate path/to/ADR.md
python -m helix.tools.adr_tool finalize path/to/ADR.md
python -m helix.tools.adr_tool next-number
```

### Docs Compiler (`helix.tools.docs_compiler`)

```bash
python -m helix.tools.docs_compiler compile    # Generate docs
python -m helix.tools.docs_compiler validate   # Check without writing
python -m helix.tools.docs_compiler sources    # List sources
python -m helix.tools.docs_compiler diff       # Show changes
```

### Verify Phase Tool

```bash
python -m helix.tools.verify_phase
```

---

## Hilfe

- **HELIX Konzept**: [ONBOARDING.md](ONBOARDING.md)
- **Architektur**: [docs/ARCHITECTURE-MODULES.md](docs/ARCHITECTURE-MODULES.md)
- **ADR Template**: [docs/ADR-TEMPLATE.md](docs/ADR-TEMPLATE.md)
- **Skills**: `skills/` für Domain-Wissen

---
